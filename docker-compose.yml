services:
  postgres:
    image: postgres:16-alpine
    container_name: vp_postgres
    environment:
      POSTGRES_DB: videoplatform
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - vp_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d videoplatform"]
      interval: 5s
      timeout: 3s
      retries: 20

  minio:
    image: minio/minio:RELEASE.2025-01-31T00-00-00Z
    container_name: vp_minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - vp_minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 3s
      retries: 20

  minio_init:
    image: minio/mc:RELEASE.2025-01-31T00-00-00Z
    container_name: vp_minio_init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-lc"]
    command: |
      set -e
      mc alias set local http://minio:9000 minioadmin minioadmin
      mc mb -p local/videoplatform || true
      mc anonymous set none local/videoplatform || true
      cat > /tmp/cors.json <<'JSON'
      [
        {
          "AllowedOrigins": ["http://localhost:3000", "http://127.0.0.1:3000"],
          "AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
          "AllowedHeaders": ["*"],
          "ExposeHeaders": ["ETag", "x-amz-request-id", "x-amz-id-2"],
          "MaxAgeSeconds": 3000
        }
      ]
      JSON
      mc cors set local/videoplatform /tmp/cors.json
      echo "MinIO bucket ready: videoplatform"

volumes:
  vp_postgres_data:
  vp_minio_data:
