generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum PlanStatus {
  ACTIVE
  INACTIVE
}

enum PaymentStatus {
  CREATED
  PAID
  FAILED
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String
  role         Role     @default(USER)
  planStatus   PlanStatus @default(ACTIVE)
  planActiveUntil DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  assignments  CourseAssignment[]
  progress     VideoProgress[]
  refreshTokens RefreshToken[]
  payments     Payment[]
}

model Payment {
  id               String        @id @default(cuid())
  provider         String
  providerOrderId  String        @unique
  providerPaymentId String?
  userId           String
  courseId         String
  amount           Decimal
  currency         String        @default("INR")
  status           PaymentStatus @default(CREATED)
  couponId         String?
  rawPayload       Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  coupon Coupon? @relation(fields: [couponId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([courseId, createdAt])
}

model Coupon {
  id              String   @id @default(cuid())
  code            String   @unique
  courseId        String?
  percentOff      Int?
  amountOffPaise  Int?
  active          Boolean  @default(true)
  expiresAt       DateTime?
  maxRedemptions  Int?
  redeemedCount   Int      @default(0)
  createdAt       DateTime @default(now())

  course Course? @relation(fields: [courseId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([courseId])
}

model RefreshToken {
  id         String   @id @default(cuid())
  userId     String
  tokenHash  String
  revokedAt  DateTime?
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Course {
  id          String   @id @default(cuid())
  title       String
  description String
  thumbnailKey String?
  priceInrPaise Int @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lectures    Lecture[]
  attachments Attachment[]
  assignments CourseAssignment[]
  coupons     Coupon[]
  payments    Payment[]

  @@index([createdAt])
}

model Lecture {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String
  notesMd     String?
  orderIndex  Int
  videoKey    String
  storageProviderId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  storageProvider StorageProvider? @relation(fields: [storageProviderId], references: [id], onDelete: SetNull)
  progress VideoProgress[]
  attachments Attachment[]

  @@unique([courseId, orderIndex])
  @@index([courseId])
  @@index([storageProviderId])
}

model Attachment {
  id          String   @id @default(cuid())
  courseId    String
  lectureId   String?
  title       String
  fileKey     String
  mimeType    String
  sizeBytes   Int?
  storageProviderId String?
  createdAt   DateTime @default(now())

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lecture Lecture? @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  storageProvider StorageProvider? @relation(fields: [storageProviderId], references: [id], onDelete: SetNull)

  @@index([courseId])
  @@index([lectureId])
  @@index([storageProviderId])
}

model StorageProvider {
  id            String   @id @default(cuid())
  name          String   @unique
  endpoint      String?
  region        String
  bucket        String
  accessKeyId   String
  secretEnc     String
  forcePathStyle Boolean @default(false)
  active        Boolean  @default(true)
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lectures      Lecture[]
  attachments   Attachment[]

  @@index([active])
  @@index([isDefault])
}

model CourseAssignment {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
}

model VideoProgress {
  id          String   @id @default(cuid())
  userId      String
  lectureId   String
  progressPct Float    @default(0)
  updatedAt   DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lecture Lecture @relation(fields: [lectureId], references: [id], onDelete: Cascade)

  @@unique([userId, lectureId])
  @@index([lectureId])
}
